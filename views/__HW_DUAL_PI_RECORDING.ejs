<head>
    <title>DUAL PI RECORDING</title>
    <style>
        html, body {
            overflow-y: scroll !important;
            height: auto !important;
            margin: 0;
            padding: 0;
        }
        
        .blockContent {
            overflow: visible !important;
            max-height: none !important;
            height: auto !important;
        }
        
        .scrollable-container {
            height: auto !important;
            overflow: visible !important;
            padding: 10px;
        }
        
        .videoplayer_container {
            height: auto !important;
            max-height: none !important;
            overflow: visible !important;
            position: static !important;  /* Override absolute positioning */
            left: auto !important;
            right: auto !important;
            margin: 10px !important;      /* Replace left/right positioning */
        }
        
        .log-container {
            height: 150px;
            overflow-y: auto;
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            border-radius: 5px;
            max-width: 100%;
        }
        
        .log-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .log-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .log-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .log-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<div class=blockContent><%- include('__HW_SIO.ejs') %></div>

<!-- Sound iframe commented out - no auto-play sound needed -->
<!-- <iframe src="/hw_sounds/carSounds/HW10_TEST_SOUND_PLAY.html" style="display:none">SOUNDS</iframe> -->

<div class="scrollable-container">
    <div id="DIV_DUAL_PI" class="videoplayer_container">
        <div class="videoplayer_header">DUAL PI RECORDING SYSTEM</div>
        
        <div style="text-align: center; margin: 20px; padding: 20px; background: #f5f5f5; border-radius: 10px;">
            <div style="margin: 10px;">
                Duration: <input type="number" id="duration" value="5" min="1" max="30" style="width: 60px;">
                FPS: <select id="fps" style="width: 80px;">
                    <option value="60">60</option>
                    <option value="120" selected>120</option>
                    <option value="240">240</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 20px; margin: 20px 0; justify-content: center; flex-wrap: wrap;">
                <div style="text-align: left; min-width: 200px;">
                    <strong>ELP Camera Settings:</strong><br>
                    Resolution: <select id="elp-resolution" style="width: 120px;">
                        <option value="1920x1080" selected>1920x1080</option>
                        <option value="1280x720">1280x720</option>
                        <option value="640x480">640x480</option>
                    </select><br>
                    Exposure: <select id="elp-exposure" style="width: 120px;">
                        <option value="auto">Auto</option>
                        <option value="100">100Œºs</option>
                        <option value="500">500Œºs</option>
                        <option value="1000" selected>1000Œºs</option>
                        <option value="2000">2000Œºs</option>
                    </select><br>
                    Gain: <input type="text" id="elp-gain" value="10" style="width: 120px;" placeholder="0-30 or auto"><br>
                    Brightness: <input type="text" id="elp-brightness" value="128" style="width: 120px;" placeholder="0-255">
                </div>
                
                <div style="text-align: left; min-width: 200px;">
                    <strong>Daheng Camera Settings:</strong><br>
                    Resolution: <select id="daheng-resolution" style="width: 120px;">
                        <option value="1440x1080" selected>1440x1080</option>
                        <option value="1280x960">1280x960</option>
                        <option value="640x480">640x480</option>
                    </select><br>
                    Exposure: <select id="daheng-exposure" style="width: 120px;">
                        <option value="500">500Œºs</option>
                        <option value="1000">1000Œºs</option>
                        <option value="1500" selected>1500Œºs</option>
                        <option value="2000">2000Œºs</option>
                        <option value="3000">3000Œºs</option>
                    </select><br>
                    Gain: <input type="text" id="daheng-gain" value="24" style="width: 120px;" placeholder="0-40"><br>
                    Gamma: <input type="text" id="daheng-gamma" value="0.4" style="width: 120px;" placeholder="0.1-2.0 (lower=brighter)"><br>
                    Contrast: <input type="text" id="daheng-contrast" value="-50" style="width: 120px;" placeholder="-100 to 100"><br>
                </div>
            </div>
            
            <button onclick="startDualRecording()" style="padding: 15px 30px; font-size: 18px;">START DUAL RECORDING</button>
            <button onclick="stopRecording()" style="padding: 10px 20px; font-size: 14px; margin-left: 10px; background: #e74c3c;">STOP/RESET</button>
            <button onclick="refreshVideos()" style="padding: 10px 20px; font-size: 14px; margin-left: 10px; background: #3498db;">REFRESH VIDEOS</button>
            <button onclick="testVideoLinks()" style="padding: 10px 20px; font-size: 14px; margin-left: 10px; background: #27ae60;">TEST VIDEO LINKS</button>
            <button onclick="diagnoseVideos()" style="padding: 10px 20px; font-size: 14px; margin-left: 10px; background: #9b59b6;">DIAGNOSE</button>
            
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                <strong>üîß Diagnostics:</strong>
                <button onclick="pingPis()" style="padding: 10px 20px; font-size: 14px; margin-left: 10px; background: #f39c12; color: white;">üèì PING PIs</button>
                <button onclick="getConnectionStatus()" style="padding: 10px 20px; font-size: 14px; margin-left: 10px; background: #1abc9c; color: white;">üì° CONNECTION STATUS</button>
            </div>
        </div>
        
        <!-- Recording Log - Moved to top for visibility -->
        <div style="margin: 20px; background: white; padding: 15px; border-radius: 10px;">
            <h3 style="margin-top: 0;">üìä Recording Log</h3>
            <div id="recording-log" class="log-container">
                <div style="color: green;">‚óè System ready - Configure settings and click "START DUAL RECORDING"</div>
            </div>
        </div>
        
        <div style="display: flex; gap: 20px; margin: 20px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 300px; background: white; padding: 15px; border-radius: 10px;">
                <h3 style="text-align: center; margin-top: 0;">Sensor Pi (ELP Camera)</h3>
                <video id="sensor_video" width="100%" height="200" controls style="border-radius: 8px;" preload="none">
                    <source src="video/raspi_sensor.mp4" type="video/mp4">
                    <p>Sensor Pi video: raspi_sensor.mp4</p>
                </video>
                <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">
                    File: raspi_sensor.mp4 | Last Update: <span id="sensor-timestamp">Never</span>
                </div>
            </div>
            <div style="flex: 1; min-width: 300px; background: white; padding: 15px; border-radius: 10px;">
                <h3 style="text-align: center; margin-top: 0;">Main Pi (Daheng Camera)</h3>
                <video id="main_video" width="100%" height="200" controls style="border-radius: 8px;" preload="none">
                    <source src="video/raspi_main.mp4" type="video/mp4">
                    <p>Main Pi video: raspi_main.mp4</p>
                </video>
                <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">
                    File: raspi_main.mp4 | Last Update: <span id="main-timestamp">Never</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function log(message, type = 'info') {
    const logDiv = document.getElementById('recording-log');
    const timestamp = new Date().toLocaleTimeString();
    const colors = {
        info: '#333',
        success: 'green',
        error: 'red',
        warning: 'orange'
    };
    
    const logEntry = document.createElement('div');
    logEntry.style.color = colors[type] || colors.info;
    logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
    
    logDiv.appendChild(logEntry);
    logDiv.scrollTop = logDiv.scrollHeight;
    
    // Keep only last 50 entries
    while (logDiv.children.length > 50) {
        logDiv.removeChild(logDiv.firstChild);
    }
}

function getSettings() {
    const elpRes = document.getElementById('elp-resolution').value.split('x');
    const dahengRes = document.getElementById('daheng-resolution').value.split('x');
    
    return {
        duration: parseInt(document.getElementById('duration').value),
        fps: parseInt(document.getElementById('fps').value),
        // ELP settings
        width: parseInt(elpRes[0]),
        height: parseInt(elpRes[1]),
        elp_exposure: document.getElementById('elp-exposure').value,
        elp_gain: document.getElementById('elp-gain').value,
        elp_brightness: document.getElementById('elp-brightness').value,
        // Daheng settings
        daheng_width: parseInt(dahengRes[0]),
        daheng_height: parseInt(dahengRes[1]),
        daheng_exposure: document.getElementById('daheng-exposure').value,
        daheng_gain: document.getElementById('daheng-gain').value,
        daheng_gamma: document.getElementById('daheng-gamma').value,
        daheng_contrast: document.getElementById('daheng-contrast').value,
        daheng_fps: parseInt(document.getElementById('fps').value)
    };
}

async function startDualRecording() {
    const settings = getSettings();
    
    log('üé¨ Starting dual Pi recording via test script...', 'info');
    log(`‚ö±Ô∏è Command: node test_dual_pi_recording.js ${settings.duration}`, 'info');
    log(`‚è±Ô∏è Duration: ${settings.duration}s`, 'info');
    
    try {
        const response = await fetch('/api/dual-pi-record', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                duration: settings.duration
            })
        });
        
        const result = await response.json();
        if (result.success) {
            log('‚úÖ Test script started successfully', 'success');
            log('üìã Real-time script output will appear below...', 'info');
            
            // Update start button to show it's running
            const startButton = document.querySelector('button[onclick="startDualRecording()"]');
            startButton.textContent = 'RUNNING TEST SCRIPT...';
            startButton.disabled = true;
            startButton.style.background = '#ff9800';
            startButton.style.color = 'white';
            
        } else {
            if (result.error && result.error.includes('already in progress')) {
                log('‚ö†Ô∏è Recording already in progress - stopping first...', 'warning');
                await stopRecording();
                setTimeout(() => startDualRecording(), 2000);
            } else {
                log('‚ùå Failed to start test script: ' + result.error, 'error');
            }
        }
    } catch (error) {
        log('‚ùå Network error: ' + error.message, 'error');
    }
}

async function stopRecording() {
    log('üõë Stopping/Resetting recording state...', 'info');
    
    try {
        // Try regular stop first
        const response = await fetch('/api/dual-pi-stop', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        if (result.success) {
            log('‚úÖ Recording stopped/reset successfully', 'success');
        } else {
            log('‚ö†Ô∏è Normal stop failed, trying force reset...', 'warning');
            
            // Try force reset
            const resetResponse = await fetch('/api/dual-pi-reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const resetResult = await resetResponse.json();
            if (resetResult.success) {
                log('‚úÖ Recording state force reset successfully', 'success');
            } else {
                log('‚ùå Force reset failed: ' + (resetResult.error || 'Unknown error'), 'error');
            }
        }
    } catch (error) {
        log('‚ùå Error stopping/resetting recording: ' + error.message, 'error');
    }
}

function refreshVideos() {
    const timestamp = Date.now();
    const sensorVideo = document.getElementById('sensor_video');
    const mainVideo = document.getElementById('main_video');
    
    log('üîÑ Refreshing videos...', 'info');
    log('üîç Looking for: video/raspi_sensor.mp4 and video/raspi_main.mp4', 'info');
    
    if (sensorVideo) {
        sensorVideo.src = `video/raspi_sensor.mp4?t=${timestamp}`;
        sensorVideo.load();
        document.getElementById('sensor-timestamp').textContent = new Date().toLocaleTimeString();
        log('üîÑ Sensor Pi video source updated to: video/raspi_sensor.mp4', 'success');
    }
    
    if (mainVideo) {
        mainVideo.src = `video/raspi_main.mp4?t=${timestamp}`;
        mainVideo.load();
        document.getElementById('main-timestamp').textContent = new Date().toLocaleTimeString();
        log('üîÑ Main Pi video source updated to: video/raspi_main.mp4', 'success');
    }
}

async function testVideoLinks() {
    log('üîç Testing video file accessibility...', 'info');
    
    const videoFiles = ['raspi_sensor.mp4', 'raspi_main.mp4'];
    
    try {
        // Test all video files
        for (const filename of videoFiles) {
            const response = await fetch(`video/${filename}`, { method: 'HEAD' });
            if (response.ok) {
                const size = response.headers.get('content-length');
                const sizeInMB = size ? (parseInt(size) / 1024 / 1024).toFixed(1) + 'MB' : 'unknown size';
                log(`‚úÖ ${filename} accessible (${sizeInMB})`, 'success');
            } else {
                log(`‚ùå ${filename} not accessible: HTTP ${response.status}`, 'error');
            }
        }
        
        // Check video elements
        const sensorVideo = document.getElementById('sensor_video');
        const mainVideo = document.getElementById('main_video');
        
        log('--- Video Element Status ---', 'info');
        log(`üìπ Sensor video element: ${sensorVideo ? 'Found' : 'Missing'}`, sensorVideo ? 'success' : 'error');
        log(`üìπ Main video element: ${mainVideo ? 'Found' : 'Missing'}`, mainVideo ? 'success' : 'error');
        
        if (sensorVideo) {
            log(`üìπ Sensor current src: ${sensorVideo.src}`, 'info');
            log(`üìπ Sensor ready state: ${sensorVideo.readyState} (0=nothing, 1=metadata, 4=ready)`, 'info');
            log(`üìπ Sensor network state: ${sensorVideo.networkState}`, 'info');
        }
        
        if (mainVideo) {
            log(`üìπ Main current src: ${mainVideo.src}`, 'info');
            log(`üìπ Main ready state: ${mainVideo.readyState} (0=nothing, 1=metadata, 4=ready)`, 'info');
            log(`üìπ Main network state: ${mainVideo.networkState}`, 'info');
        }
        
        // Force refresh after test
        log('üîÑ Force refreshing videos after test...', 'info');
        setTimeout(refreshVideos, 500);
        
    } catch (error) {
        log(`‚ùå Error testing video links: ${error.message}`, 'error');
    }
}

async function diagnoseVideos() {
    log('üî¨ Diagnosing video issues...', 'info');
    
    const videoFiles = ['raspi_sensor.mp4', 'raspi_main.mp4'];
    
    try {
        for (const filename of videoFiles) {
            log(`--- Diagnosing ${filename} ---`, 'info');
            
            // 1. Check if file exists and get headers
            const response = await fetch(`video/${filename}`, { method: 'HEAD' });
            if (!response.ok) {
                log(`‚ùå ${filename} not found (HTTP ${response.status})`, 'error');
                continue;
            }
            
            const size = response.headers.get('content-length');
            const contentType = response.headers.get('content-type');
            const lastModified = response.headers.get('last-modified');
            const etag = response.headers.get('etag');
            
            log(`üìä ${filename} size: ${size} bytes (${(size/1024/1024).toFixed(1)}MB)`, 'info');
            log(`üìä Content-Type: ${contentType}`, 'info');
            log(`üìä Last-Modified: ${lastModified}`, 'info');
            log(`üìä ETag: ${etag}`, 'info');
            
            // 2. Try to read first few bytes to check file header
            try {
                const partialResponse = await fetch(`video/${filename}`, {
                    headers: { 'Range': 'bytes=0-31' }
                });
                
                if (partialResponse.ok) {
                    const bytes = await partialResponse.arrayBuffer();
                    const view = new Uint8Array(bytes);
                    const header = Array.from(view).map(b => b.toString(16).padStart(2, '0')).join(' ');
                    log(`üìä File header (32 bytes): ${header}`, 'info');
                    
                    // Check for MP4 signature
                    if (view[4] === 0x66 && view[5] === 0x74 && view[6] === 0x79 && view[7] === 0x70) {
                        log(`‚úÖ Valid MP4 signature detected`, 'success');
                    } else {
                        log(`‚ö†Ô∏è MP4 signature not found - file may be corrupted`, 'warning');
                    }
                } else {
                    log(`‚ùå Could not read file header (HTTP ${partialResponse.status})`, 'error');
                }
            } catch (headerError) {
                log(`‚ùå Error reading file header: ${headerError.message}`, 'error');
            }
            
            // 3. Create a test video element
            const testVideo = document.createElement('video');
            testVideo.style.display = 'none';
            document.body.appendChild(testVideo);
            
            testVideo.addEventListener('loadedmetadata', function() {
                log(`‚úÖ ${filename} metadata loaded: ${testVideo.duration}s, ${testVideo.videoWidth}x${testVideo.videoHeight}`, 'success');
                document.body.removeChild(testVideo);
            });
            
            testVideo.addEventListener('error', function(e) {
                log(`‚ùå ${filename} failed to load in test element: ${e.message}`, 'error');
                document.body.removeChild(testVideo);
            });
            
            testVideo.src = `video/${filename}?diagnostic=${Date.now()}`;
        }
        
    } catch (error) {
        log(`‚ùå Diagnostic error: ${error.message}`, 'error');
    }
}

document.addEventListener("DOMContentLoaded", function () {
    log('üöÄ Dual Pi Recording System initialized', 'success');
    
    // Force load existing videos
    setTimeout(function() {
        const timestamp = Date.now();
        const sensorVideo = document.getElementById('sensor_video');
        const mainVideo = document.getElementById('main_video');
        
        if (sensorVideo) {
            sensorVideo.src = `video/raspi_sensor.mp4?t=${timestamp}`;
            sensorVideo.load();
            log('üìπ Loading Sensor Pi video: video/raspi_sensor.mp4', 'info');
            
            sensorVideo.addEventListener('loadedmetadata', function() {
                log('‚úÖ Sensor Pi video loaded successfully', 'success');
                document.getElementById('sensor-timestamp').textContent = new Date().toLocaleTimeString();
            });
            
            let sensorVideoRetryCount = 0;
            sensorVideo.addEventListener('error', function(e) {
                if (sensorVideoRetryCount >= 2) {
                    log('‚ùå Sensor Pi video failed after 3 attempts - giving up', 'error');
                    return;
                }
                sensorVideoRetryCount++;
                
                log(`‚ùå Sensor Pi video failed to load (attempt ${sensorVideoRetryCount}/3)`, 'error');
                
                // Check if file exists without retrying
                fetch('video/raspi_sensor.mp4', { method: 'HEAD' })
                    .then(response => {
                        if (response.ok) {
                            const size = response.headers.get('content-length');
                            log(`‚úÖ Sensor Pi video file exists (${size} bytes) - but won't load`, 'warning');
                        } else {
                            log('‚ùå Sensor Pi video file not found (HTTP ' + response.status + ')', 'error');
                        }
                    })
                    .catch(err => log('‚ùå Error checking Sensor Pi file: ' + err.message, 'error'));
            });
        }
        
        if (mainVideo) {
            mainVideo.src = `video/raspi_main.mp4?t=${timestamp}`;
            mainVideo.load();
            log('üìπ Loading Main Pi video: video/raspi_main.mp4', 'info');
            
            mainVideo.addEventListener('loadedmetadata', function() {
                log('‚úÖ Main Pi video loaded successfully', 'success');
                document.getElementById('main-timestamp').textContent = new Date().toLocaleTimeString();
            });
            
            let mainVideoRetryCount = 0;
            mainVideo.addEventListener('error', function(e) {
                if (mainVideoRetryCount >= 2) {
                    log('‚ùå Main Pi video failed after 3 attempts - giving up', 'error');
                    return;
                }
                mainVideoRetryCount++;
                
                log(`‚ùå Main Pi video failed to load (attempt ${mainVideoRetryCount}/3)`, 'error');
                
                // Check if file exists without retrying
                fetch('video/raspi_main.mp4', { method: 'HEAD' })
                    .then(response => {
                        if (response.ok) {
                            const size = response.headers.get('content-length');
                            log(`‚úÖ Main Pi video file exists (${size} bytes) - but won't load`, 'warning');
                        } else {
                            log('‚ùå Main Pi video file not found (HTTP ' + response.status + ')', 'error');
                        }
                    })
                    .catch(err => log('‚ùå Error checking Main Pi file: ' + err.message, 'error'));
            });
            
            mainVideo.addEventListener('loadstart', function() {
                log('üì° Main Pi video loading started...', 'info');
            });
        }
    }, 1000);
    
    // Socket.IO real-time updates
    if (typeof S2 !== 'undefined') {
        S2.on('DUAL_PI_UPDATE', function(data) {
            // Handle test script output
            if (data.type === 'log') {
                log(`üìã ${data.message}`, 'info');
            } else if (data.type === 'error') {
                log(`‚ùå ${data.message}`, 'error');
            } else {
                // Legacy format support
                const piName = data.piId === 'raspi_sensor' ? 'Sensor Pi' : 'Main Pi';
                
                switch(data.type) {
                    case 'recording_started':
                        log(`‚ñ∂Ô∏è ${piName}: Recording started`, 'success');
                        break;
                    case 'recording_stopped':
                        log(`‚èπÔ∏è ${piName}: Recording completed`, 'success');
                        break;
                    case 'video_uploaded':
                        log(`üì§ ${piName}: Video uploaded`, 'success');
                        break;
                    case 'recording_error':
                        log(`‚ùå ${piName}: Error - ${data.error}`, 'error');
                        break;
                }
            }
        });
        
        S2.on('DUAL_PI_COMPLETE', function(data) {
            // Reset button state when script completes
            const startButton = document.querySelector('button[onclick="startDualRecording()"]');
            startButton.textContent = 'START DUAL RECORDING';
            startButton.disabled = false;
            startButton.style.background = '';
            startButton.style.color = '';
            
            if (data.success) {
                log('üéâ Test script completed successfully!', 'success');
                log('üì§ Videos should now be available - refreshing display...', 'info');
                setTimeout(refreshVideos, 2000);
            } else {
                log('‚ùå Test script failed: ' + (data.error || data.message), 'error');
            }
        });
        
        S2.on('NEW_VIDEO_READY', function(data) {
            const piName = data.piId === 'raspi_sensor' ? 'Sensor Pi' : 'Main Pi';
            log(`üé• ${piName}: New video ready (${data.filename})`, 'success');
            refreshVideos();
        });
        
        // Listen for general Raspberry Pi responses (useful for debugging)
        S2.on('RASPI_RESPONSE', function(data) {
            if (data.action === 'pong' || data.message?.type === 'pong') {
                const piId = data.message?.raspiId || data.from?.replace('RASPI_', '');
                const piName = piId === 'raspi_sensor' ? 'Sensor Pi' : piId === 'raspi_main' ? 'Main Pi' : piId;
                log(`üèì ${piName}: Pong received via Socket.IO`, 'success');
            } else if (data.action === 'CONNECTED') {
                const piId = data.message?.raspiId || data.from?.replace('RASPI_', '');
                const piName = piId === 'raspi_sensor' ? 'Sensor Pi' : piId === 'raspi_main' ? 'Main Pi' : piId;
                log(`üü¢ ${piName}: Connected`, 'success');
            } else if (data.action === 'DISCONNECTED') {
                const piId = data.message?.raspiId || data.from?.replace('RASPI_', '');
                const piName = piId === 'raspi_sensor' ? 'Sensor Pi' : piId === 'raspi_main' ? 'Main Pi' : piId;
                log(`üî¥ ${piName}: Disconnected`, 'error');
            }
        });
    } else {
        log('‚ö†Ô∏è Socket.IO not available - real-time updates disabled', 'warning');
    }
    
    // Make functions globally available for onclick handlers
    window.startDualRecording = startDualRecording;
    window.stopRecording = stopRecording;
    window.refreshVideos = refreshVideos;
    window.testVideoLinks = testVideoLinks;
    window.diagnoseVideos = diagnoseVideos;
    window.pingPis = pingPis;
    window.getConnectionStatus = getConnectionStatus;
});

async function pingPis() {
    log('üèì Pinging both Raspberry Pis...', 'info');
    
    try {
        const response = await fetch('/api/dual-pi-ping', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
            log('üì° Ping request sent - waiting for responses...', 'info');
            
            // Show ping results
            if (result.results) {
                Object.entries(result.results).forEach(([piId, pingResult]) => {
                    const piName = piId === 'raspi_sensor' ? 'Sensor Pi' : 'Main Pi';
                    if (pingResult.success) {
                        log(`‚úÖ ${piName} (${pingResult.host}): ${pingResult.message}`, 'success');
                    } else {
                        log(`‚ùå ${piName} (${pingResult.host || 'unknown'}): ${pingResult.error}`, 'error');
                    }
                });
            }
            
            // Summary
            const successCount = Object.values(result.results || {}).filter(r => r.success).length;
            const totalCount = Object.keys(result.results || {}).length;
            
            if (successCount === totalCount && totalCount > 0) {
                log(`üéâ All ${totalCount} Pis responded to ping!`, 'success');
            } else if (successCount > 0) {
                log(`‚ö†Ô∏è ${successCount}/${totalCount} Pis responded to ping`, 'warning');
            } else {
                log(`‚ùå No Pis responded to ping (0/${totalCount})`, 'error');
            }
        } else {
            log('‚ùå Ping request failed: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        log('‚ùå Network error during ping: ' + error.message, 'error');
    }
}

async function getConnectionStatus() {
    log('üì° Checking connection status of all Pis...', 'info');
    
    try {
        const response = await fetch('/api/dual-pi-status', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        log('--- Connection Status ---', 'info');
        log(`üé¨ Recording in progress: ${result.isRecording ? 'Yes' : 'No'}`, result.isRecording ? 'warning' : 'info');
        log(`‚öôÔ∏è Active process: ${result.hasActiveProcess ? 'Yes' : 'No'}`, result.hasActiveProcess ? 'warning' : 'info');
        
        // Also fetch the multi-pi connection status
        const statusResponse = await fetch('/api/dual-pi-connection-status', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (statusResponse.ok) {
            const connections = await statusResponse.json();
            
            if (connections.pis && Object.keys(connections.pis).length > 0) {
                log('--- Raspberry Pi Connections ---', 'info');
                Object.entries(connections.pis).forEach(([piId, status]) => {
                    const piName = piId === 'raspi_sensor' ? 'Sensor Pi' : 'Main Pi';
                    const connStatus = status.connected ? 'üü¢ Connected' : 'üî¥ Disconnected';
                    log(`${connStatus} ${piName}: ${status.host}:${status.port}`, status.connected ? 'success' : 'error');
                });
            } else {
                log('‚ö†Ô∏è No Raspberry Pis configured in connection pool', 'warning');
            }
        }
        
    } catch (error) {
        log('‚ùå Error checking connection status: ' + error.message, 'error');
    }
}
</script>
